{% extends "base.html" %}

{% block content %}
<div class="mb-8">
    <!-- Actions Bar -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
        <input type="text" 
               name="q"
               hx-get="/search" 
               hx-trigger="keyup changed delay:200ms" 
               hx-target="#snippet-grid" 
               placeholder="> search snippets..." 
               class="terminal-input flex-grow p-3 rounded font-mono text-sm w-full md:w-2/3">
        
        <button onclick="document.getElementById('add-form').toggleAttribute('open')" 
                class="terminal-btn px-6 py-3 rounded font-bold text-sm text-center">
            + NEW SNIPPET
        </button>
    </div>

    <!-- Add Form (Collapsible) -->
    <details id="add-form" class="mb-8 border border-border rounded bg-card open:p-4 transition-all">
        <summary id="form-title" class="cursor-pointer font-bold text-accent list-none hidden">New Snippet</summary>
        <form hx-post="/add" hx-target="#snippet-grid" hx-on::after-request="resetForm(); document.getElementById('add-form').removeAttribute('open')">
            <input type="hidden" name="snippet_id" id="snippet-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="text" name="title" placeholder="Title (e.g. Tar Extract)" required 
                       class="terminal-input p-2 rounded w-full">
                <select name="language" id="lang-select" required class="terminal-input p-2 rounded w-full appearance-none cursor-pointer">
                    <option value="plaintext">Select Language...</option>
                    <option value="shell">Bash / Shell</option>
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="css">CSS</option>
                    <option value="html">HTML</option>
                    <option value="json">JSON</option>
                    <option value="sql">SQL</option>
                    <option value="rust">Rust</option>
                    <option value="go">Go</option>
                    <option value="cpp">C++</option>
                    <option value="plaintext">Plain Text</option>
                </select>
            </div>
            
            <!-- Monaco Editor Container -->
            <div class="terminal-input p-0 rounded w-full mb-4 border border-border overflow-hidden relative">
                <div id="monaco-editor" class="w-full h-[300px]"></div>
                <input type="hidden" name="code" id="code-input">
            </div>
            
            <input type="text" name="tags" placeholder="Tags (comma separated)" 
                   class="terminal-input p-2 rounded w-full mb-4">
            
            <div class="flex justify-end gap-2">
                <button type="button" onclick="resetForm(); document.getElementById('add-form').removeAttribute('open')" 
                        class="text-gray-500 hover:text-white px-4 py-2 text-sm">Cancel</button>
                <button type="submit" id="save-btn" class="terminal-btn px-6 py-2 rounded font-bold text-sm">SAVE</button>
            </div>
        </form>
    </details>
</div>

<!-- Monaco Editor Initialization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
<script>
    function resetForm() {
        document.querySelector('form').reset();
        document.getElementById('snippet-id').value = "";
        document.getElementById('form-title').innerText = "New Snippet";
        document.getElementById('save-btn').innerText = "SAVE";
        if (window.monacoEditor) {
            window.monacoEditor.setValue('');
        }
    }

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});

    require(['vs/editor/editor.main'], function() {
        // Initialize Editor
        window.monacoEditor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: '',
            language: 'plaintext',
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: false }, // Cleaner look
            fontSize: 14,
            fontFamily: 'JetBrains Mono',
            scrollBeyondLastLine: false,
            padding: { top: 16, bottom: 16 }
        });

        // Sync Language Dropdown
        document.getElementById('lang-select').addEventListener('change', function(e) {
            let lang = e.target.value;
            // Map common names if necessary, Monaco uses standard IDs
            monaco.editor.setModelLanguage(window.monacoEditor.getModel(), lang);
        });

        // REAL-TIME SYNC: Update hidden input whenever editor content changes
        // This ensures HTMX always grabs the latest data
        window.monacoEditor.onDidChangeModelContent(() => {
            document.getElementById("code-input").value = window.monacoEditor.getValue();
        });
        
        // Handle "New Snippet" open to fix layout issues (Monaco needs to know its size)
        document.getElementById('add-form').addEventListener('toggle', function(e) {
            if (this.open) {
                setTimeout(() => {
                    if (window.monacoEditor) window.monacoEditor.layout();
                }, 50);
            }
        });
    });
</script>

<!-- Snippet Grid -->
<div id="snippet-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% include 'snippet_list.html' %}
</div>
{% endblock %}
