<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeSnip</title>
    <link rel="icon" type="image/png" href="/static/assets/icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- CodeJar for Mini IDE Editor -->
    <script type="module">
      import { CodeJar } from 'https://medv.io/codejar/codejar.js'
      window.CodeJar = CodeJar;
    </script>
    
    <!-- Pickr for Color Picking -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/monolith.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Hack:wght@400;700&family=JetBrains+Mono:wght@100..800&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/styles.css?v=2">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        text: 'var(--text)',
                        accent: 'var(--accent)',
                        success: 'var(--success)',
                        border: 'var(--border)',
                        card: 'var(--card)',
                    },
                    fontFamily: {
                        mono: ['var(--font-primary, "JetBrains Mono")', 'monospace']
                    }
                }
            }
        }
    </script>
</head>
<body class="p-6 md:p-12 min-h-screen">
    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex justify-between items-center border-b border-border pb-4">
            <h1 class="text-3xl font-bold text-accent tracking-tighter">
                <span class="text-success">$</span> VibeSnip
            </h1>
        </header>
        
        {% block content %}{% endblock %}

        <footer class="mt-12 pt-6 border-t border-border flex justify-between items-center text-sm text-gray-500">
            <div class="flex items-center gap-4">
                <span>v1.2.0</span>
                <a href="https://github.com/FewLy-Torch-1861/vibesnip" target="_blank" class="flex items-center gap-1 hover:text-accent transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg>
                    GitHub
                </a>
                <button onclick="toggleCommandPalette()" class="flex items-center gap-1 hover:text-accent transition-colors" title="Command Palette (Alt+K)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-4.3-4.3"></path><path d="M11 8a7 7 0 1 0 0 14 7 7 0 0 0 0-14z"></path></svg>
                    Cmd
                </button>
            </div>
            <div class="relative group" id="theme-picker-container">
                <button id="theme-picker-btn" class="flex items-center gap-2 text-xs uppercase tracking-wider font-bold text-gray-500 hover:text-accent transition-colors outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.375 2.625a3.875 3.875 0 0 0-5.48 0l-9.51 9.51a3.75 3.75 0 0 0 0 5.3l3.18 3.18a3.75 3.75 0 0 0 5.3 0l9.51-9.51a3.875 3.875 0 0 0 0-5.48z"></path><path d="M12 10.5l4.5 4.5"></path></svg>
                    <span id="current-theme-label">Catppuccin</span>
                </button>

                <!-- Custom Dropdown Menu -->
                <div id="theme-dropdown" class="absolute bottom-full right-0 mb-2 w-48 bg-card border border-border rounded shadow-xl opacity-0 invisible transform translate-y-2 transition-all duration-200 z-50">
                    <div class="p-1 space-y-0.5" id="theme-options-list">
                        <!-- Options injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Edit Theme Button (Hidden by default) -->
            <button id="edit-theme-btn" class="hidden text-accent hover:text-white transition-colors ml-2" title="Edit Custom Theme">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
            </div>
        </footer>
    </div>

    <!-- Shortcuts Modal -->
    <dialog id="shortcuts-modal" class="bg-card border border-border text-text rounded-lg shadow-2xl backdrop:bg-black/50 backdrop:backdrop-blur-sm p-6 w-[95%] max-w-md">
        <h3 class="text-xl font-bold text-accent mb-4 border-b border-border pb-2">Keyboard Shortcuts</h3>
        <ul class="space-y-2 text-sm">
            <li class="flex justify-between"><span class="text-gray-400">Search</span> <kbd class="bg-border px-2 py-0.5 rounded font-mono text-xs"> / </kbd></li>
            <li class="flex justify-between"><span class="text-gray-400">Command Palette</span> <kbd class="bg-border px-2 py-0.5 rounded font-mono text-xs">Alt + k</kbd></li>
             <li class="flex justify-between"><span class="text-gray-400">New Snippet</span> <kbd class="bg-border px-2 py-0.5 rounded font-mono text-xs">Alt + n</kbd></li>
             <li class="flex justify-between"><span class="text-gray-400">Previous Snippet</span> <kbd class="bg-border px-2 py-0.5 rounded font-mono text-xs">k</kbd></li>
             <li class="flex justify-between"><span class="text-gray-400">Next Snippet</span> <kbd class="bg-border px-2 py-0.5 rounded font-mono text-xs">j</kbd></li>
             <li class="flex justify-between"><span class="text-gray-400">Edit Current</span> <kbd class="bg-border px-2 py-0.5 rounded font-mono text-xs">e</kbd></li>
            <li class="flex justify-between"><span class="text-gray-400">Show/Hide Help</span> <kbd class="bg-border px-2 py-0.5 rounded font-mono text-xs"> ? </kbd></li>
        </ul>
        <div class="mt-6 flex justify-end">
             <button onclick="document.getElementById('shortcuts-modal').close()" class="px-4 py-2 bg-accent text-bg text-xs font-bold rounded hover:brightness-110">CLOSE</button>
        </div>
    </dialog>

    <!-- Command Palette -->
    <dialog id="command-palette" class="bg-card border border-border text-text rounded-lg shadow-2xl backdrop:bg-black/50 backdrop:backdrop-blur-sm w-[95%] max-w-lg p-0 overflow-hidden top-[20%] m-auto">
        <div class="p-2 border-b border-border flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m21 21-4.3-4.3"></path><path d="M11 8a7 7 0 1 0 0 14 7 7 0 0 0 0-14z"></path></svg>
            <input type="text" id="cp-input" class="w-full bg-transparent border-none text-text focus:outline-none text-lg" placeholder="Type a command...">
             <kbd class="text-[10px] bg-border px-1.5 rounded text-gray-400">ESC</kbd>
        </div>
        <div id="cp-results" class="max-h-64 overflow-y-auto p-1">
            <!-- Results injected here -->
        </div>
    </dialog>
    
    <script>
        // State
        const state = {
            themes: [],
            activeThemeId: null, // ID of theme currently being edited
            pickrs: {},
            currentAppTheme: localStorage.getItem('vibesnip-theme') || 'catppuccin',
            commands: [
                { id: 'add', label: 'Add New Snippet', icon: 'plus', action: () => { document.getElementById('add-form').setAttribute('open', ''); document.querySelector('input[name=\'title\']').focus(); } },
                { id: 'search', label: 'Search Snippets', icon: 'search', action: () => { document.querySelector('input[name=\'q\']').focus(); } },
                 { id: 'theme', label: 'Change Theme', icon: 'palette', action: () => { document.getElementById('theme-picker-btn').click(); } },
                 { id: 'help', label: 'Keyboard Shortcuts', icon: 'help-circle', action: () => { document.getElementById('shortcuts-modal').showModal(); } },
                 { id: 'export', label: 'Export Backup (JSON)', icon: 'download', action: () => window.location.href = '/export' },
                 { id: 'import', label: 'Import Backup (JSON)', icon: 'upload', action: () => document.getElementById('snippet-import-input').click() },
                 { id: 'github', label: 'Open GitHub Repo', icon: 'github', action: () => window.open('https://github.com/FewLy-Torch-1861/vibesnip', '_blank') },
                 { id: 'reset', label: 'Reset UI', icon: 'refresh-cw', action: () => window.location.reload() }
            ]
        };

        // DOM Elements
        const els = {
            modal: document.getElementById('theme-modal'),
            themeList: document.getElementById('theme-list'),
            // Replaced themeSelector with custom components
            themePickerBtn: document.getElementById('theme-picker-btn'),
            themeDropdown: document.getElementById('theme-dropdown'),
            themeOptionsList: document.getElementById('theme-options-list'),
            currentThemeLabel: document.getElementById('current-theme-label'),
            
            editBtn: document.getElementById('edit-theme-btn'),
            nameInput: document.getElementById('theme-name-input'),
            fontSelector: document.getElementById('font-selector'), // New Element
            saveBtn: document.getElementById('save-theme'),
            deleteBtn: document.getElementById('delete-theme-btn'),
            addBtn: document.getElementById('add-theme-btn'),
            closeBtn: document.getElementById('close-modal'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importInput: document.getElementById('import-input'),

            // Command Palette
            cpDialog: document.getElementById('command-palette'),
            cpInput: document.getElementById('cp-input'),
            cpResults: document.getElementById('cp-results')
        };

        // Defaults
        const defaultColors = {
            bg: '#1e1e2e',
            card: '#181825',
            text: '#cdd6f4',
            border: '#45475a',
            accent: '#89b4fa',
            success: '#a6e3a1'
        };
        
        const defaultFont = "'JetBrains Mono', monospace";

        // --- Core Logic ---

        function init() {
            migrateOldThemes(); // Migration Step
            loadThemes();
            initPickrs();
            updateThemeSelector();
            applyTheme(state.currentAppTheme);
            setupEventListeners();
        }

        // Migration for users coming from v1.0
        function migrateOldThemes() {
            const oldSingle = localStorage.getItem('vibesnip-custom-theme');
            const newArray = localStorage.getItem('vibesnip-custom-themes');
            
            // If we have an old theme but no new array
            if (oldSingle && !newArray) {
                try {
                    const parsed = JSON.parse(oldSingle);
                    // Convert to new format
                    const migrated = [{
                        id: 'custom-' + Date.now(),
                        name: 'My Custom Theme',
                        colors: parsed, // Old format was just colors
                        font: defaultFont
                    }];
                    localStorage.setItem('vibesnip-custom-themes', JSON.stringify(migrated));
                    localStorage.removeItem('vibesnip-custom-theme'); // Clean up
                    console.log("Migrated legacy custom theme.");
                } catch(e) {
                    console.error("Migration failed", e);
                }
            }
        }

        function loadThemes() {
            const stored = localStorage.getItem('vibesnip-custom-themes');
            state.themes = stored ? JSON.parse(stored) : [];
        }

        function saveThemes() {
            localStorage.setItem('vibesnip-custom-themes', JSON.stringify(state.themes));
            updateThemeSelector();
        }

        function applyTheme(themeId) {
            let themeName = '';

            // Check if it's a custom theme (starts with 'custom-')
            if (themeId && themeId.startsWith('custom-')) {
                const theme = state.themes.find(t => t.id === themeId);
                if (theme) {
                    document.documentElement.setAttribute('data-theme', 'custom');
                    applyCustomVars(theme.colors, theme.font);
                    els.editBtn.classList.remove('hidden');
                    themeName = theme.name;
                } else {
                    // Fallback if custom theme deleted
                    applyTheme('catppuccin'); 
                    return;
                }
            } else {
                // Preset Theme
                if (themeId === 'catppuccin') {
                    document.documentElement.removeAttribute('data-theme');
                } else {
                    document.documentElement.setAttribute('data-theme', themeId);
                }
                removeCustomVars();
                els.editBtn.classList.add('hidden');
                themeName = themeId.charAt(0).toUpperCase() + themeId.slice(1);
            }
            
            state.currentAppTheme = themeId;
            localStorage.setItem('vibesnip-theme', themeId);
            if(els.currentThemeLabel) els.currentThemeLabel.textContent = themeName;
            
            // Re-render selector to update highlights
            updateThemeSelector();

            // Close dropdown if open
            if(els.themeDropdown) {
                 els.themeDropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
                 els.themeDropdown.classList.add('opacity-0', 'invisible', 'translate-y-2');
            }
        }

        function applyCustomVars(vars, font) {
            const root = document.documentElement;
            Object.keys(vars).forEach(key => {
                root.style.setProperty(`--${key}`, vars[key]);
            });
            // Apply Font
            root.style.setProperty('--font-primary', font || defaultFont);
        }

        function removeCustomVars() {
            const root = document.documentElement;
            ['bg', 'text', 'accent', 'success', 'border', 'card', 'font-primary'].forEach(key => {
                root.style.removeProperty(`--${key}`);
            });
        }

        // --- Editor Logic ---

        function openEditor(themeIdToEdit = null) {
            loadThemes(); // Refresh
            renderThemeList();
            
            if (themeIdToEdit) {
                selectThemeForEditing(themeIdToEdit);
            } else if (state.currentAppTheme.startsWith('custom-')) {
                selectThemeForEditing(state.currentAppTheme);
            } else if (state.themes.length > 0) {
                selectThemeForEditing(state.themes[0].id);
            } else {
                createNewTheme();
            }

            els.modal.showModal();
        }

        function createNewTheme() {
            const newTheme = {
                id: `custom-${Date.now()}`,
                name: 'New Theme',
                colors: { ...defaultColors },
                font: defaultFont
            };
            state.themes.push(newTheme);
            saveThemes();
            renderThemeList();
            selectThemeForEditing(newTheme.id);
        }

        function selectThemeForEditing(id) {
            state.activeThemeId = id;
            const theme = state.themes.find(t => t.id === id);
            if (!theme) return;

            // Update UI
            els.nameInput.value = theme.name;
            if(els.fontSelector) els.fontSelector.value = theme.font || defaultFont;
            
            // Update Sidebar Highlight
            document.querySelectorAll('.theme-item').forEach(el => {
                if(el.dataset.id === id) el.classList.add('bg-white/10', 'border-accent');
                else el.classList.remove('bg-white/10', 'border-accent');
            });

            // Update Pickrs
            Object.keys(state.pickrs).forEach(key => {
                state.pickrs[key].setColor(theme.colors[key]);
            });

            // Live Preview
            applyCustomVars(theme.colors, theme.font);
        }


        function renderThemeList() {
            els.themeList.innerHTML = '';
            state.themes.forEach(theme => {
                const item = document.createElement('div');
                item.className = 'theme-item p-2 md:p-3 rounded cursor-pointer border border-transparent hover:bg-white/5 transition-colors group flex items-center shrink-0';
                item.dataset.id = theme.id;
                item.innerHTML = `
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="w-4 h-4 rounded-full border border-white/20 shadow-sm shrink-0" style="background: ${theme.colors.accent}"></div>
                        <span class="font-bold text-xs md:text-sm truncate max-w-[100px] md:max-w-[128px]">${theme.name}</span>
                    </div>
                `;
                item.addEventListener('click', () => selectThemeForEditing(theme.id));
                els.themeList.appendChild(item);
            });
        }

        function initPickrs() {
            document.querySelectorAll('.picker-container').forEach(container => {
                const key = container.dataset.color;
                state.pickrs[key] = Pickr.create({
                    el: container,
                    container: document.getElementById('theme-modal'),
                    theme: 'monolith',
                    default: defaultColors[key],
                    components: {
                        preview: true,
                        opacity: true,
                        hue: true,
                        interaction: {
                            hex: true,
                            rgba: true,
                            input: true,
                            save: false 
                        }
                    }
                });

                state.pickrs[key].on('change', (color, source, instance) => {
                    if (state.activeThemeId) {
                        const hex = color.toHEXA().toString();
                        // Live Preview
                        document.documentElement.style.setProperty(`--${key}`, hex);
                    }
                });
            });
        }

        function updateThemeSelector() {
            els.themeOptionsList.innerHTML = '';
            
            // Render Presets
            const presets = ['catppuccin', 'gruvbox', 'rosepine', 'adwaita', 'dracula'];
            presets.forEach(p => {
                createOption(p, p.charAt(0).toUpperCase() + p.slice(1));
            });

            // Divider
            const divider = document.createElement('div');
            divider.className = 'h-px bg-border my-1';
            els.themeOptionsList.appendChild(divider);
            
            const label = document.createElement('div');
            label.className = 'px-2 py-1 text-[10px] uppercase font-bold text-gray-500';
            label.textContent = 'Custom';
            els.themeOptionsList.appendChild(label);

            // Custom Themes
            if (state.themes.length > 0) {
                state.themes.forEach(t => {
                    createOption(t.id, t.name, t.colors.accent);
                });
            } else {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'px-2 py-1 text-xs text-gray-500 italic';
                emptyMsg.textContent = 'No custom themes';
                els.themeOptionsList.appendChild(emptyMsg);
            }

            // Create New Button
            const createBtn = document.createElement('button');
            createBtn.className = 'w-full text-left px-2 py-1 text-xs rounded hover:bg-white/10 flex items-center gap-2 text-success font-bold mt-1 transition-colors';
            createBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>Create New</span>
            `;
            createBtn.addEventListener('click', () => {
                // Determine if we need to manually create one
                // openEditor() already creates one IF the list is empty.
                // If the list is NOT empty, openEditor selects the first one.
                // So if list is NOT empty, we must force create new.
                
                if (state.themes.length === 0) {
                     openEditor(); // This handles creation internally for empty state
                } else {
                     createNewTheme(); // Force create new
                     els.modal.showModal(); // Open modal
                }

                // Close dropdown
                els.themeDropdown.classList.add('opacity-0', 'invisible', 'translate-y-2');
                els.themeDropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
            });
            els.themeOptionsList.appendChild(createBtn);
        }

        function createOption(id, label, accentColor = null) {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left px-2 py-1 text-xs rounded hover:bg-white/10 flex items-center gap-2 transition-colors';
            if(state.currentAppTheme === id) btn.classList.add('text-accent');
            else btn.classList.add('text-text');

            let dot = '';
            if(accentColor) {
                dot = `<div class="w-2 h-2 rounded-full" style="background: ${accentColor}"></div>`;
            }

            btn.innerHTML = `${dot}<span>${label}</span>`;
            btn.addEventListener('click', () => applyTheme(id));
            els.themeOptionsList.appendChild(btn);
        }

        // --- Event Listeners ---

        function setupEventListeners() {
            // Dropdown Toggle
            els.themePickerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                els.themeDropdown.classList.toggle('opacity-0');
                els.themeDropdown.classList.toggle('invisible');
                els.themeDropdown.classList.toggle('translate-y-2');
                els.themeDropdown.classList.toggle('opacity-100');
                els.themeDropdown.classList.toggle('visible');
                els.themeDropdown.classList.toggle('translate-y-0');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!els.themePickerBtn.contains(e.target) && !els.themeDropdown.contains(e.target)) {
                    els.themeDropdown.classList.add('opacity-0', 'invisible', 'translate-y-2');
                    els.themeDropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
                }
            });
            
            // Open Modal
            if(els.editBtn) els.editBtn.addEventListener('click', () => openEditor());

            // Add New Theme
            els.addBtn.addEventListener('click', createNewTheme);

            // Save Theme
            els.saveBtn.addEventListener('click', () => {
                if(!state.activeThemeId) return;
                
                // Update State
                const themeIdx = state.themes.findIndex(t => t.id === state.activeThemeId);
                if(themeIdx > -1) {
                    state.themes[themeIdx].name = els.nameInput.value;
                    // Get Font
                    if(els.fontSelector) state.themes[themeIdx].font = els.fontSelector.value;
                    
                    // Get colors from pickrs
                    Object.keys(state.pickrs).forEach(key => {
                        state.themes[themeIdx].colors[key] = state.pickrs[key].getColor().toHEXA().toString();
                    });
                    
                    saveThemes();
                    applyTheme(state.activeThemeId); // Re-apply to ensure consistency
                    els.modal.close();
                }
            });

            // Live Font Preview
            if(els.fontSelector) {
                els.fontSelector.addEventListener('change', (e) => {
                    document.documentElement.style.setProperty('--font-primary', e.target.value);
                });
            }

            // Delete Theme
            els.deleteBtn.addEventListener('click', () => {
                if(!state.activeThemeId) return;
                if(confirm('Are you sure you want to delete this theme?')) {
                    state.themes = state.themes.filter(t => t.id !== state.activeThemeId);
                    saveThemes();
                    
                    // If we deleted the active one, switch to default
                    if(state.currentAppTheme === state.activeThemeId) {
                        applyTheme('catppuccin');
                    }
                    
                    // Refresh Editor or Close
                    if(state.themes.length > 0) {
                        selectThemeForEditing(state.themes[0].id);
                        renderThemeList();
                    } else {
                        els.modal.close();
                    }
                }
            });

            // Cancel / Close
            els.closeBtn.addEventListener('click', () => {
                els.modal.close();
                // Revert to current app theme (cancels live preview effects)
                applyTheme(state.currentAppTheme);
            });

            // Export
            els.exportBtn.addEventListener('click', () => {
                if(!state.activeThemeId) return;
                const theme = state.themes.find(t => t.id === state.activeThemeId);
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(theme, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", (theme.name.replace(/\s+/g, '_').toLowerCase() || "theme") + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            // Import
            const importMobile = document.getElementById('import-btn-mobile');
            if(importMobile) importMobile.addEventListener('click', () => els.importInput.click());
            
            els.importBtn.addEventListener('click', () => els.importInput.click());
            els.importInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if(imported.colors && imported.name) {
                            imported.id = `custom-${Date.now()}`; // Ensure unique ID
                            state.themes.push(imported);
                            saveThemes();
                            renderThemeList();
                            selectThemeForEditing(imported.id);
                        } else {
                            alert("Invalid theme file.");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error parsing JSON.");
                    }
                };
                reader.readAsText(file);
                // Reset input
                e.target.value = '';
            });
        }

        // Run
        init();

        // Initialize Highlight.js
        hljs.highlightAll();

        // Re-highlight after HTMX swaps (like searching or adding)
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });

        function copyToClipboard(btn) {
            const card = btn.closest('.relative');
            const code = card.querySelector('code').textContent; // Use textContent for raw text
            
            // Try modern API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(code).then(() => showFeedback(btn));
            } else {
                // Fallback for HTTP/LAN
                const textArea = document.createElement("textarea");
                textArea.value = code;
                textArea.style.position = "fixed"; // Avoid scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showFeedback(btn);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    alert("Copy failed. Browser security may be blocking it.");
                }
                document.body.removeChild(textArea);
            }
        }

        function showFeedback(btn) {
            const originalText = btn.innerText;
            btn.innerText = "COPIED!";
            setTimeout(() => btn.innerText = originalText, 2000);
        }

        async function loadSnippet(id) {
            try {
                const response = await fetch(`/snippets/${id}`);
                if (!response.ok) throw new Error("Failed to fetch snippet");
                const data = await response.json();
                
                // Populate Form
                const form = document.querySelector('form');
                form.title.value = data.title;
                form.language.value = data.language;
                form.tags.value = data.tags;
                
                // Populate Monaco
                if (window.monacoEditor) {
                    window.monacoEditor.setValue(data.code);
                    monaco.editor.setModelLanguage(window.monacoEditor.getModel(), data.language);
                }

                // Set ID
                document.getElementById('snippet-id').value = data.id;
                
                // Open Form & UI Updates
                const details = document.getElementById('add-form');
                details.open = true;
                
                document.getElementById('form-title').innerText = "Edit Snippet #" + id;
                document.getElementById('save-btn').innerText = "UPDATE";
                
                // Force Monaco Layout Refresh (crucial when opening <details>)
                setTimeout(() => {
                    if (window.monacoEditor) window.monacoEditor.layout();
                }, 100);

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                console.error(e);
                alert("Error loading snippet: " + e.message);
            }
        }

        function filterByTag(tagName) {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = tagName;
                searchInput.focus();
                // Show clear button if it exists
                const clearBtn = document.getElementById('clear-search');
                if (clearBtn) clearBtn.classList.remove('hidden');
                
                // Trigger HTMX search
                htmx.trigger(searchInput, 'keyup');
            }
        }

        // --- Command Palette Logic ---

        function toggleCommandPalette() {
            if (els.cpDialog.open) {
                els.cpDialog.close();
            } else {
                els.cpDialog.showModal();
                els.cpInput.value = '';
                renderCommandResults(state.commands);
                els.cpInput.focus();
            }
        }

        function renderCommandResults(commands) {
            els.cpResults.innerHTML = '';
            if (commands.length === 0) {
                els.cpResults.innerHTML = '<div class="p-2 text-sm text-gray-500">No commands found</div>';
                return;
            }

            commands.forEach((cmd, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-white/10 group transition-colors';
                // Simple feather icon replacement logic or just text
                // Using basic SVG placeholders for icons based on ID
                let iconSvg = '';
                if(cmd.icon === 'plus') iconSvg = '<path d="M12 5v14M5 12h14"/>';
                else if(cmd.icon === 'search') iconSvg = '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>';
                else if(cmd.icon === 'palette') iconSvg = '<circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>';
                else if(cmd.icon === 'help-circle') iconSvg = '<circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/>';
                else if(cmd.icon === 'github') iconSvg = '<path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/>';
                else if(cmd.icon === 'download') iconSvg = '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>';
                else if(cmd.icon === 'upload') iconSvg = '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>';
                else if(cmd.icon === 'refresh-cw') iconSvg = '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/>';

                item.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 group-hover:text-accent">${iconSvg}</svg>
                    <span class="text-sm font-bold text-gray-300 group-hover:text-white">${cmd.label}</span>
                `;
                item.addEventListener('click', () => {
                    cmd.action();
                    els.cpDialog.close();
                });
                els.cpResults.appendChild(item);
            });
        }

        // Global Shortcuts
        document.addEventListener('keydown', (e) => {
            // Shortcuts Help (?) - Shift + /
            if (e.key === '?' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                e.preventDefault();
                const modal = document.getElementById('shortcuts-modal');
                modal.open ? modal.close() : modal.showModal();
            }

            // Command Palette (Alt + K)
            if (e.altKey && e.code === 'KeyK') {
                e.preventDefault();
                toggleCommandPalette();
            }
            
            // New Snippet (Alt + N)
            if (e.altKey && e.code === 'KeyN') {
                 e.preventDefault();
                 document.getElementById('add-form').setAttribute('open', ''); 
                 document.querySelector('input[name="title"]').focus();
            }

            // Command Palette Input Handling
            if (els.cpDialog.open) {
                if (e.key === 'Escape') {
                    els.cpDialog.close();
                }
                if (e.key === 'Enter') {
                    // Execute first visible command
                    const firstItem = els.cpResults.querySelector('div');
                    if (firstItem) firstItem.click();
                }
            }
        });

        // Command Palette Filter
        if(els.cpInput) {
            els.cpInput.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                const filtered = state.commands.filter(c => c.label.toLowerCase().includes(val));
                renderCommandResults(filtered);
            });
        }

    </script>
    <input type="file" id="snippet-import-input" class="hidden" accept=".json">
    <script>
        document.getElementById('snippet-import-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    const response = await fetch('/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(`Successfully imported ${result.count} snippets!`);
                        window.location.reload();
                    } else {
                        const err = await response.json();
                        alert("Import failed: " + (err.detail || "Unknown error"));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error parsing JSON: " + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset
        });
    </script>
</body>
</html>
