<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeSnip</title>
    <link rel="icon" type="image/png" href="/static/assets/icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- CodeJar for Mini IDE Editor -->
    <script type="module">
      import { CodeJar } from 'https://medv.io/codejar/codejar.js'
      window.CodeJar = CodeJar;
    </script>
    
    <!-- Pickr for Color Picking -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/monolith.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Hack:wght@400;700&family=JetBrains+Mono:wght@100..800&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/styles.css?v=2">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        text: 'var(--text)',
                        accent: 'var(--accent)',
                        success: 'var(--success)',
                        border: 'var(--border)',
                        card: 'var(--card)',
                    },
                    fontFamily: {
                        mono: ['var(--font-primary, "JetBrains Mono")', 'monospace']
                    }
                }
            }
        }
    </script>
</head>
<body class="p-6 md:p-12 min-h-screen">
    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex justify-between items-center border-b border-border pb-4">
            <h1 class="text-3xl font-bold text-accent tracking-tighter">
                <span class="text-success">$</span> VibeSnip
            </h1>
        </header>
        
        {% block content %}{% endblock %}

        <footer class="mt-12 pt-6 border-t border-border flex justify-between items-center text-sm text-gray-500">
            <div class="flex items-center gap-4">
                <span>v1.1.3</span>
                <a href="https://github.com/FewLy-Torch-1861/vibesnip" target="_blank" class="flex items-center gap-1 hover:text-accent transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg>
                    GitHub
                </a>
            </div>
            <div class="relative group" id="theme-picker-container">
                <button id="theme-picker-btn" class="flex items-center gap-2 text-xs uppercase tracking-wider font-bold text-gray-500 hover:text-accent transition-colors outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.375 2.625a3.875 3.875 0 0 0-5.48 0l-9.51 9.51a3.75 3.75 0 0 0 0 5.3l3.18 3.18a3.75 3.75 0 0 0 5.3 0l9.51-9.51a3.875 3.875 0 0 0 0-5.48z"></path><path d="M12 10.5l4.5 4.5"></path></svg>
                    <span id="current-theme-label">Catppuccin</span>
                </button>

                <!-- Custom Dropdown Menu -->
                <div id="theme-dropdown" class="absolute bottom-full right-0 mb-2 w-48 bg-card border border-border rounded shadow-xl opacity-0 invisible transform translate-y-2 transition-all duration-200 z-50">
                    <div class="p-1 space-y-0.5" id="theme-options-list">
                        <!-- Options injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Edit Theme Button (Hidden by default) -->
            <button id="edit-theme-btn" class="hidden text-accent hover:text-white transition-colors ml-2" title="Edit Custom Theme">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
            </div>
        </footer>
    </div>

    <!-- Custom Theme Modal -->
    <dialog id="theme-modal" class="bg-card border border-border text-text rounded-lg shadow-2xl backdrop:bg-black/50 backdrop:backdrop-blur-sm w-[95%] max-w-4xl p-0 overflow-hidden">
        <div class="flex flex-col md:flex-row h-[85vh] md:h-[500px]">
            <!-- Sidebar: Theme List -->
            <div class="w-full md:w-64 bg-black/20 border-b md:border-b-0 md:border-r border-border flex flex-col h-24 md:h-full shrink-0">
                <div class="p-2 md:p-4 border-b border-border flex justify-between items-center">
                    <h3 class="font-bold text-xs md:text-sm uppercase tracking-wider opacity-70">My Themes</h3>
                    <button id="add-theme-btn" class="text-success hover:text-white transition-colors" title="Create New Theme">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div id="theme-list" class="flex-1 overflow-x-auto md:overflow-y-auto p-2 flex flex-row md:flex-col gap-2 md:gap-1 items-center md:items-stretch">
                    <!-- Theme Items will be injected here -->
                </div>
                <div class="p-4 border-t border-border hidden md:block">
                    <button id="import-btn" class="w-full flex items-center justify-center gap-2 text-xs font-bold border border-border py-2 rounded hover:bg-white/5 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        IMPORT JSON
                    </button>
                </div>
            </div>

            <!-- Main: Editor -->
            <div class="flex-1 flex flex-col bg-card overflow-hidden">
                <div class="p-2 md:p-6 border-b border-border flex justify-between items-center bg-black/10 shrink-0">
                    <div class="flex items-center gap-2 md:gap-3 flex-1 mr-2 md:mr-4">
                        <input type="text" id="theme-name-input" class="bg-transparent border-none text-base md:text-xl font-bold text-text focus:outline-none focus:ring-2 focus:ring-accent/50 rounded px-1 md:px-2 w-full" placeholder="Untitled Theme">
                    </div>
                    <div class="flex gap-1 md:gap-2">
                         <button id="export-btn" class="text-gray-400 hover:text-accent transition-colors p-2" title="Export JSON">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        </button>
                        <button id="import-btn-mobile" class="md:hidden text-gray-400 hover:text-accent transition-colors p-2" title="Import JSON">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </button>
                        <button id="delete-theme-btn" class="text-gray-400 hover:text-red-500 transition-colors p-2" title="Delete Theme">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="p-2 md:p-8 flex-1 overflow-y-auto scrollbar-thin">
                    <!-- Typography Section -->
                    <div class="mb-3 md:mb-8 flex flex-col md:block">
                        <div class="flex items-center gap-2 md:block">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 whitespace-nowrap md:mb-2">Typography</label>
                            <div class="relative flex-1">
                                <select id="font-selector" class="w-full bg-black/20 border border-border rounded px-2 py-1 text-xs text-text appearance-none focus:border-accent focus:outline-none cursor-pointer h-7">
                                    <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                                    <option value="'Fira Code', monospace">Fira Code</option>
                                    <option value="'Source Code Pro', monospace">Source Code Pro</option>
                                    <option value="'Hack', monospace">Hack</option>
                                    <option value="'Roboto Mono', monospace">Roboto Mono</option>
                                </select>
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colors Grid -->
                    <div class="grid grid-cols-3 md:grid-cols-2 gap-2 md:gap-x-8 md:gap-y-6">
                        <div class="flex flex-col items-center md:items-start space-y-1">
                            <span class="text-[9px] md:text-xs uppercase font-bold text-gray-500 text-center md:text-left truncate w-full">Bg</span>
                            <div class="picker-container" data-color="bg"></div>
                        </div>
                        <div class="flex flex-col items-center md:items-start space-y-1">
                            <span class="text-[9px] md:text-xs uppercase font-bold text-gray-500 text-center md:text-left truncate w-full">Card</span>
                            <div class="picker-container" data-color="card"></div>
                        </div>
                        <div class="flex flex-col items-center md:items-start space-y-1">
                            <span class="text-[9px] md:text-xs uppercase font-bold text-gray-500 text-center md:text-left truncate w-full">Text</span>
                            <div class="picker-container" data-color="text"></div>
                        </div>
                         <div class="flex flex-col items-center md:items-start space-y-1">
                            <span class="text-[9px] md:text-xs uppercase font-bold text-gray-500 text-center md:text-left truncate w-full">Border</span>
                            <div class="picker-container" data-color="border"></div>
                        </div>
                        <div class="flex flex-col items-center md:items-start space-y-1">
                            <span class="text-[9px] md:text-xs uppercase font-bold text-gray-500 text-center md:text-left truncate w-full">Accent</span>
                            <div class="picker-container" data-color="accent"></div>
                        </div>
                        <div class="flex flex-col items-center md:items-start space-y-1">
                            <span class="text-[9px] md:text-xs uppercase font-bold text-gray-500 text-center md:text-left truncate w-full">Success</span>
                            <div class="picker-container" data-color="success"></div>
                        </div>
                    </div>
                </div>

                <div class="p-2 md:p-6 border-t border-border flex justify-end gap-2 md:gap-3 bg-black/10 shrink-0">
                    <button id="close-modal" class="px-3 py-2 md:px-4 text-xs md:text-sm font-bold text-gray-400 hover:text-white transition-colors">CANCEL</button>
                    <button id="save-theme" class="px-4 py-2 md:px-6 bg-accent text-bg text-xs md:text-sm font-bold rounded shadow-lg hover:filter hover:brightness-110 transition-all">SAVE CHANGES</button>
                </div>
            </div>
        </div>
        <input type="file" id="import-input" class="hidden" accept=".json">
    </dialog>
    
    <script>
        // State
        const state = {
            themes: [],
            activeThemeId: null, // ID of theme currently being edited
            pickrs: {},
            currentAppTheme: localStorage.getItem('vibesnip-theme') || 'catppuccin'
        };

        // DOM Elements
        const els = {
            modal: document.getElementById('theme-modal'),
            themeList: document.getElementById('theme-list'),
            // Replaced themeSelector with custom components
            themePickerBtn: document.getElementById('theme-picker-btn'),
            themeDropdown: document.getElementById('theme-dropdown'),
            themeOptionsList: document.getElementById('theme-options-list'),
            currentThemeLabel: document.getElementById('current-theme-label'),
            
            editBtn: document.getElementById('edit-theme-btn'),
            nameInput: document.getElementById('theme-name-input'),
            fontSelector: document.getElementById('font-selector'), // New Element
            saveBtn: document.getElementById('save-theme'),
            deleteBtn: document.getElementById('delete-theme-btn'),
            addBtn: document.getElementById('add-theme-btn'),
            closeBtn: document.getElementById('close-modal'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importInput: document.getElementById('import-input')
        };

        // Defaults
        const defaultColors = {
            bg: '#1e1e2e',
            card: '#181825',
            text: '#cdd6f4',
            border: '#45475a',
            accent: '#89b4fa',
            success: '#a6e3a1'
        };
        
        const defaultFont = "'JetBrains Mono', monospace";

        // --- Core Logic ---

        function init() {
            migrateOldThemes(); // Migration Step
            loadThemes();
            initPickrs();
            updateThemeSelector();
            applyTheme(state.currentAppTheme);
            setupEventListeners();
        }

        // Migration for users coming from v1.0
        function migrateOldThemes() {
            const oldSingle = localStorage.getItem('vibesnip-custom-theme');
            const newArray = localStorage.getItem('vibesnip-custom-themes');
            
            // If we have an old theme but no new array
            if (oldSingle && !newArray) {
                try {
                    const parsed = JSON.parse(oldSingle);
                    // Convert to new format
                    const migrated = [{
                        id: 'custom-' + Date.now(),
                        name: 'My Custom Theme',
                        colors: parsed, // Old format was just colors
                        font: defaultFont
                    }];
                    localStorage.setItem('vibesnip-custom-themes', JSON.stringify(migrated));
                    localStorage.removeItem('vibesnip-custom-theme'); // Clean up
                    console.log("Migrated legacy custom theme.");
                } catch(e) {
                    console.error("Migration failed", e);
                }
            }
        }

        function loadThemes() {
            const stored = localStorage.getItem('vibesnip-custom-themes');
            state.themes = stored ? JSON.parse(stored) : [];
        }

        function saveThemes() {
            localStorage.setItem('vibesnip-custom-themes', JSON.stringify(state.themes));
            updateThemeSelector();
        }

        function applyTheme(themeId) {
            let themeName = '';

            // Check if it's a custom theme (starts with 'custom-')
            if (themeId && themeId.startsWith('custom-')) {
                const theme = state.themes.find(t => t.id === themeId);
                if (theme) {
                    document.documentElement.setAttribute('data-theme', 'custom');
                    applyCustomVars(theme.colors, theme.font);
                    els.editBtn.classList.remove('hidden');
                    themeName = theme.name;
                } else {
                    // Fallback if custom theme deleted
                    applyTheme('catppuccin'); 
                    return;
                }
            } else {
                // Preset Theme
                if (themeId === 'catppuccin') {
                    document.documentElement.removeAttribute('data-theme');
                } else {
                    document.documentElement.setAttribute('data-theme', themeId);
                }
                removeCustomVars();
                els.editBtn.classList.add('hidden');
                themeName = themeId.charAt(0).toUpperCase() + themeId.slice(1);
            }
            
            state.currentAppTheme = themeId;
            localStorage.setItem('vibesnip-theme', themeId);
            if(els.currentThemeLabel) els.currentThemeLabel.textContent = themeName;
            
            // Re-render selector to update highlights
            updateThemeSelector();

            // Close dropdown if open
            if(els.themeDropdown) {
                 els.themeDropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
                 els.themeDropdown.classList.add('opacity-0', 'invisible', 'translate-y-2');
            }
        }

        function applyCustomVars(vars, font) {
            const root = document.documentElement;
            Object.keys(vars).forEach(key => {
                root.style.setProperty(`--${key}`, vars[key]);
            });
            // Apply Font
            root.style.setProperty('--font-primary', font || defaultFont);
        }

        function removeCustomVars() {
            const root = document.documentElement;
            ['bg', 'text', 'accent', 'success', 'border', 'card', 'font-primary'].forEach(key => {
                root.style.removeProperty(`--${key}`);
            });
        }

        // --- Editor Logic ---

        function openEditor(themeIdToEdit = null) {
            loadThemes(); // Refresh
            renderThemeList();
            
            if (themeIdToEdit) {
                selectThemeForEditing(themeIdToEdit);
            } else if (state.currentAppTheme.startsWith('custom-')) {
                selectThemeForEditing(state.currentAppTheme);
            } else if (state.themes.length > 0) {
                selectThemeForEditing(state.themes[0].id);
            } else {
                createNewTheme();
            }

            els.modal.showModal();
        }

        function createNewTheme() {
            const newTheme = {
                id: `custom-${Date.now()}`,
                name: 'New Theme',
                colors: { ...defaultColors },
                font: defaultFont
            };
            state.themes.push(newTheme);
            saveThemes();
            renderThemeList();
            selectThemeForEditing(newTheme.id);
        }

        function selectThemeForEditing(id) {
            state.activeThemeId = id;
            const theme = state.themes.find(t => t.id === id);
            if (!theme) return;

            // Update UI
            els.nameInput.value = theme.name;
            if(els.fontSelector) els.fontSelector.value = theme.font || defaultFont;
            
            // Update Sidebar Highlight
            document.querySelectorAll('.theme-item').forEach(el => {
                if(el.dataset.id === id) el.classList.add('bg-white/10', 'border-accent');
                else el.classList.remove('bg-white/10', 'border-accent');
            });

            // Update Pickrs
            Object.keys(state.pickrs).forEach(key => {
                state.pickrs[key].setColor(theme.colors[key]);
            });

            // Live Preview
            applyCustomVars(theme.colors, theme.font);
        }


        function renderThemeList() {
            els.themeList.innerHTML = '';
            state.themes.forEach(theme => {
                const item = document.createElement('div');
                item.className = 'theme-item p-2 md:p-3 rounded cursor-pointer border border-transparent hover:bg-white/5 transition-colors group flex items-center shrink-0';
                item.dataset.id = theme.id;
                item.innerHTML = `
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="w-4 h-4 rounded-full border border-white/20 shadow-sm shrink-0" style="background: ${theme.colors.accent}"></div>
                        <span class="font-bold text-xs md:text-sm truncate max-w-[100px] md:max-w-[128px]">${theme.name}</span>
                    </div>
                `;
                item.addEventListener('click', () => selectThemeForEditing(theme.id));
                els.themeList.appendChild(item);
            });
        }

        function initPickrs() {
            document.querySelectorAll('.picker-container').forEach(container => {
                const key = container.dataset.color;
                state.pickrs[key] = Pickr.create({
                    el: container,
                    container: document.getElementById('theme-modal'),
                    theme: 'monolith',
                    default: defaultColors[key],
                    components: {
                        preview: true,
                        opacity: true,
                        hue: true,
                        interaction: {
                            hex: true,
                            rgba: true,
                            input: true,
                            save: false 
                        }
                    }
                });

                state.pickrs[key].on('change', (color, source, instance) => {
                    if (state.activeThemeId) {
                        const hex = color.toHEXA().toString();
                        // Live Preview
                        document.documentElement.style.setProperty(`--${key}`, hex);
                    }
                });
            });
        }

        function updateThemeSelector() {
            els.themeOptionsList.innerHTML = '';
            
            // Render Presets
            const presets = ['catppuccin', 'gruvbox', 'rosepine', 'adwaita', 'dracula'];
            presets.forEach(p => {
                createOption(p, p.charAt(0).toUpperCase() + p.slice(1));
            });

            // Divider
            const divider = document.createElement('div');
            divider.className = 'h-px bg-border my-1';
            els.themeOptionsList.appendChild(divider);
            
            const label = document.createElement('div');
            label.className = 'px-2 py-1 text-[10px] uppercase font-bold text-gray-500';
            label.textContent = 'Custom';
            els.themeOptionsList.appendChild(label);

            // Custom Themes
            if (state.themes.length > 0) {
                state.themes.forEach(t => {
                    createOption(t.id, t.name, t.colors.accent);
                });
            } else {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'px-2 py-1 text-xs text-gray-500 italic';
                emptyMsg.textContent = 'No custom themes';
                els.themeOptionsList.appendChild(emptyMsg);
            }

            // Create New Button
            const createBtn = document.createElement('button');
            createBtn.className = 'w-full text-left px-2 py-1 text-xs rounded hover:bg-white/10 flex items-center gap-2 text-success font-bold mt-1 transition-colors';
            createBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>Create New</span>
            `;
            createBtn.addEventListener('click', () => {
                // Determine if we need to manually create one
                // openEditor() already creates one IF the list is empty.
                // If the list is NOT empty, openEditor selects the first one.
                // So if list is NOT empty, we must force create new.
                
                if (state.themes.length === 0) {
                     openEditor(); // This handles creation internally for empty state
                } else {
                     createNewTheme(); // Force create new
                     els.modal.showModal(); // Open modal
                }

                // Close dropdown
                els.themeDropdown.classList.add('opacity-0', 'invisible', 'translate-y-2');
                els.themeDropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
            });
            els.themeOptionsList.appendChild(createBtn);
        }

        function createOption(id, label, accentColor = null) {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left px-2 py-1 text-xs rounded hover:bg-white/10 flex items-center gap-2 transition-colors';
            if(state.currentAppTheme === id) btn.classList.add('text-accent');
            else btn.classList.add('text-text');

            let dot = '';
            if(accentColor) {
                dot = `<div class="w-2 h-2 rounded-full" style="background: ${accentColor}"></div>`;
            }

            btn.innerHTML = `${dot}<span>${label}</span>`;
            btn.addEventListener('click', () => applyTheme(id));
            els.themeOptionsList.appendChild(btn);
        }

        // --- Event Listeners ---

        function setupEventListeners() {
            // Dropdown Toggle
            els.themePickerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                els.themeDropdown.classList.toggle('opacity-0');
                els.themeDropdown.classList.toggle('invisible');
                els.themeDropdown.classList.toggle('translate-y-2');
                els.themeDropdown.classList.toggle('opacity-100');
                els.themeDropdown.classList.toggle('visible');
                els.themeDropdown.classList.toggle('translate-y-0');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!els.themePickerBtn.contains(e.target) && !els.themeDropdown.contains(e.target)) {
                    els.themeDropdown.classList.add('opacity-0', 'invisible', 'translate-y-2');
                    els.themeDropdown.classList.remove('opacity-100', 'visible', 'translate-y-0');
                }
            });
            
            // Open Modal
            if(els.editBtn) els.editBtn.addEventListener('click', () => openEditor());

            // Add New Theme
            els.addBtn.addEventListener('click', createNewTheme);

            // Save Theme
            els.saveBtn.addEventListener('click', () => {
                if(!state.activeThemeId) return;
                
                // Update State
                const themeIdx = state.themes.findIndex(t => t.id === state.activeThemeId);
                if(themeIdx > -1) {
                    state.themes[themeIdx].name = els.nameInput.value;
                    // Get Font
                    if(els.fontSelector) state.themes[themeIdx].font = els.fontSelector.value;
                    
                    // Get colors from pickrs
                    Object.keys(state.pickrs).forEach(key => {
                        state.themes[themeIdx].colors[key] = state.pickrs[key].getColor().toHEXA().toString();
                    });
                    
                    saveThemes();
                    applyTheme(state.activeThemeId); // Re-apply to ensure consistency
                    els.modal.close();
                }
            });

            // Live Font Preview
            if(els.fontSelector) {
                els.fontSelector.addEventListener('change', (e) => {
                    document.documentElement.style.setProperty('--font-primary', e.target.value);
                });
            }

            // Delete Theme
            els.deleteBtn.addEventListener('click', () => {
                if(!state.activeThemeId) return;
                if(confirm('Are you sure you want to delete this theme?')) {
                    state.themes = state.themes.filter(t => t.id !== state.activeThemeId);
                    saveThemes();
                    
                    // If we deleted the active one, switch to default
                    if(state.currentAppTheme === state.activeThemeId) {
                        applyTheme('catppuccin');
                    }
                    
                    // Refresh Editor or Close
                    if(state.themes.length > 0) {
                        selectThemeForEditing(state.themes[0].id);
                        renderThemeList();
                    } else {
                        els.modal.close();
                    }
                }
            });

            // Cancel / Close
            els.closeBtn.addEventListener('click', () => {
                els.modal.close();
                // Revert to current app theme (cancels live preview effects)
                applyTheme(state.currentAppTheme);
            });

            // Export
            els.exportBtn.addEventListener('click', () => {
                if(!state.activeThemeId) return;
                const theme = state.themes.find(t => t.id === state.activeThemeId);
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(theme, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", (theme.name.replace(/\s+/g, '_').toLowerCase() || "theme") + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            // Import
            const importMobile = document.getElementById('import-btn-mobile');
            if(importMobile) importMobile.addEventListener('click', () => els.importInput.click());
            
            els.importBtn.addEventListener('click', () => els.importInput.click());
            els.importInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if(imported.colors && imported.name) {
                            imported.id = `custom-${Date.now()}`; // Ensure unique ID
                            state.themes.push(imported);
                            saveThemes();
                            renderThemeList();
                            selectThemeForEditing(imported.id);
                        } else {
                            alert("Invalid theme file.");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error parsing JSON.");
                    }
                };
                reader.readAsText(file);
                // Reset input
                e.target.value = '';
            });
        }

        // Run
        init();

        // Initialize Highlight.js
        hljs.highlightAll();

        // Re-highlight after HTMX swaps (like searching or adding)
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });

        function copyToClipboard(btn) {
            const card = btn.closest('.relative');
            const code = card.querySelector('code').textContent; // Use textContent for raw text
            
            // Try modern API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(code).then(() => showFeedback(btn));
            } else {
                // Fallback for HTTP/LAN
                const textArea = document.createElement("textarea");
                textArea.value = code;
                textArea.style.position = "fixed"; // Avoid scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showFeedback(btn);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    alert("Copy failed. Browser security may be blocking it.");
                }
                document.body.removeChild(textArea);
            }
        }

        function showFeedback(btn) {
            const originalText = btn.innerText;
            btn.innerText = "COPIED!";
            setTimeout(() => btn.innerText = originalText, 2000);
        }

        async function loadSnippet(id) {
            try {
                const response = await fetch(`/snippets/${id}`);
                if (!response.ok) throw new Error("Failed to fetch snippet");
                const data = await response.json();
                
                // Populate Form
                const form = document.querySelector('form');
                form.title.value = data.title;
                form.language.value = data.language;
                form.tags.value = data.tags;
                
                // Populate Monaco
                if (window.monacoEditor) {
                    window.monacoEditor.setValue(data.code);
                    monaco.editor.setModelLanguage(window.monacoEditor.getModel(), data.language);
                }

                // Set ID
                document.getElementById('snippet-id').value = data.id;
                
                // Open Form & UI Updates
                const details = document.getElementById('add-form');
                details.open = true;
                
                document.getElementById('form-title').innerText = "Edit Snippet #" + id;
                document.getElementById('save-btn').innerText = "UPDATE";
                
                // Force Monaco Layout Refresh (crucial when opening <details>)
                setTimeout(() => {
                    if (window.monacoEditor) window.monacoEditor.layout();
                }, 100);

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                console.error(e);
                alert("Error loading snippet: " + e.message);
            }
        }
    </script>
</body>
</html>
